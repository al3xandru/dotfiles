#!/usr/bin/env bash
# Args received as GIT_EXTERNAL_DIFF:
# path old-file old-hex old-mode new-file new-hex new-mode
#
if [ "$XDIFF_DEBUG" == "true" ]; then
    echo "Args count: $#"
    echo "Args      : $@"
fi
if [ $# -eq 2 ]; then
    OLD=$1
    NEW=$2
elif [ $# -eq 7 ]; then
    OLD=$2
    NEW=$5
else
    OLD=$2
    NEW=$3
fi
diffcmd=""
if [ -n "$XDIFF" ]; then
    diffcmd="$XDIFF"
elif [ $(command -v ksdiff) ]; then
        diffcmd=ksdiff
elif [ $(command -v mvim) ]; then
    diffcmd=mvim
elif [ $(command -v bbdiff) ]; then
    diffcmd=bbdiff
elif [ $(command -v vimdiff) ]; then
    diffcmd=vimdiff
fi
if [ "$XDIFF_DEBUG" == "true" ]; then
    echo "Using diff program: $diffcmd"
fi

case "$diffcmd" in
    bbdiff)
        bbdiff --wait --resume "$OLD" "$NEW"
        ;;

    ksdiff)
        if [ $# -eq 2 ]; then
            ksdiff "$OLD" "$NEW"
        else
            ksdiff --partial-changeset --relative-path "$1" -- "$OLD" "$NEW"
        fi
        ;;

    mvim)
        mvim -d -f "$OLD" "$NEW"
        ;;

    vimdiff)
        vimdiff "$OLD" "$NEW"
        ;;

    *)
        diff "$OLD" "$NEW"
        ;;
esac

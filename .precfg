#!/usr/bin/env bash

function oldvpnenv() {
    # https://pdit-document-repository.oraclecorp.com/display/DISG/PDS-DIS+How+to+Configure+Proxy
    # TODO
    # * maven
    if nc -z confluence.oraclecorp.com 80 2>/dev/null; then
        # export {http,https}_proxy=http://www-proxy.us.oracle.com:80
        export {http,https}_proxy=http://www-proxy-hqdc.us.oracle.com:80
            export no_proxy='localhost,127.0.0.1,.oracle.com,.oraclecorp.com,.grungy.us,.docker.io'
        if [ -f ~/.ssh/config_vpn ]; then
            mv ~/.ssh/config ~/.ssh/config_gen
            mv ~/.ssh/config_vpn ~/.ssh/config
        fi
    else
        unset http_proxy
        unset https_proxy
        unset no_proxy
        if [ -f ~/.ssh/config_gen ]; then
            mv ~/.ssh/config ~/.ssh/config_vpn
            mv ~/.ssh/config_gen ~/.ssh/config
        fi
    fi
}
function vpnenv() {
    case "$@" in 
        help)
            open "$HOME/Dropbox/dotfiles/docs/vpn.md"
            ;;
        web)
            (
                echo "Starting SimpleHTTPServer for oraproxy.pac"
                cd $HOME/Public && python -m SimpleHTTPServer &> /dev/null
            ) &
            ;;
        kill|killweb)
            (
                echo "...  Stopping SimpleHTTPServer"
                kill $(ps ax | grep SimpleHTTPServer | grep -v grep | awk '{print $1}')
                echo "...  SimpleHTTPServer stopped"
            )
            ;;
        *)
            local autoProxyURL="http://127.0.0.1:8000/oraproxy.pac"
            trap ctrl_c INT

            function ctrl_c() {
                echo ""
                echo "...  Untrapping"
                trap - INT
                echo "Shutting down VPN"
                (
                    echo "...  Disabling Automatic Proxy Configuration"
                    confAutoProxy "off"
                )
                (
                    echo "...  Stopping SimpleHTTPServer"
                    kill $(ps ax | grep SimpleHTTPServer | grep -v grep | awk '{print $1}')
                    echo "...  SimpleHTTPServer stopped"
                )
            }

            function confAutoProxy() {
                IFS=$'\n'
                if [ "$1" = "on" ]; then
                    echo "   ... enabling Automatic Proxy Configuration with $autoProxyURL"
                else
                    echo "   ...  disabling Automatic Proxy Configuration"
                fi


                for i in $(networksetup -listallnetworkservices | tail +2);
                do
                    if [[ $i =~ "Ethernet" ]] || [[ $i =~ "Wi-Fi" ]]; then
                        if [ "$1" = "on" ]; then
                            autoProxyURLLocal=$(networksetup -getautoproxyurl "$i" | head -1 | cut -c 6- )
                            if [ "$autoProxyURL" != "$autoProxyURLLocal" ]; then
                                networksetup -setautoproxyurl "$i" "$autoProxyURL"
                                echo "Set auto proxy for $i to $autoProxyURL (from $autoProxyURLLocal)"
                            fi
                            networksetup -setautoproxystate "$i" on
                        else
                            networksetup -setautoproxystate "$i" off
                        fi

                    fi
                done
                # if [ "$1" = "on" ]; then
                #     echo "   ... enabling Automatic Proxy Configuration with $autoProxyURL"
                #     for i in $(networksetup -listallnetworkservices | tail +2);
                #     do
                #         if [[ $i =~ "Ethernet" ]] || [[ $i =~ "Wi-Fi" ]]; then
                #             autoProxyURLLocal=$(networksetup -getautoproxyurl "$i" | head -1 | cut -c 6- )
                #             if [ "$autoProxyURL" != "$autoProxyURLLocal" ]; then
                #                 networksetup -setautoproxyurl "$i" "$autoProxyURL"
                #                 echo "Set auto proxy for $i to $autoProxyURL (from $autoProxyURLLocal)"
                #             fi
                #             networksetup -setautoproxystate "$i" on
                #         fi
                #     done
                # else
                #     echo "   ...  disabling Automatic Proxy Configuration"
                #     for i in $(networksetup -listallnetworkservices | tail +2);
                #     do
                #         if [[ $i =~ "Ethernet" ]] || [[ $i =~ "Wi-Fi" ]]; then
                #             networksetup -setautoproxystate "$i" off
                #         fi
                #     done
                # fi

                unset IFS
            }
            (
                echo "Enabling Automatic Proxy Configuration"
                confAutoProxy "on"
            ) 
            (
                echo "Starting SimpleHTTPServer for oraproxy.pac"
                cd $HOME/Public && python -m SimpleHTTPServer &> /dev/null
            ) &
            (
                echo "Starting VPN"
                openconnect --script-tun --script "ocproxy -D 8912" https://myaccess.oraclevpn.com
            )
            wait %1
            ;;
    esac
}
# export GOPATH=$HOME/workspace/sandbox/go:$HOME/.golang
alias brewrepair='sudo chown -R $(whoami) /usr/local/bin /usr/local/lib'
 
